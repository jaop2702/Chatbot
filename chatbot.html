<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Asistente</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Variables de Color (Azul Tecnol√≥gico) */
        :root {
            --primary-dark-blue: #1A2F4F; /* Azul oscuro para fondos principales */
            --primary-medium-blue: #007BFF; /* Azul medio para acentos y mensajes de usuario */
            --light-bg-blue: #F0F4F8; /* Gris azulado claro para fondos de chat */
            --text-dark: #333333; /* Texto oscuro */
            --text-medium: #666666; /* Texto secundario / gris medio */
            --white: #FFFFFF; /* Blanco */
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            /* Estos estilos de body pueden interferir con Odoo si se aplican globalmente */
            /* background-color: var(--light-bg-blue); */
            color: var(--text-dark);
        }

        /* Estilos para el bot√≥n de abrir el chat (flotante) */
        .open-chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--primary-dark-blue); /* Color azul oscuro */
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001; /* Asegura que est√© por encima del chat abierto */
            /* Transiciones para el fondo, transformaci√≥n y visibilidad */
            transition: background-color 0.3s ease, transform 0.2s ease, opacity 0.3s ease, visibility 0.3s ease;
            overflow: hidden;
        }

        .open-chat-button:hover {
            background-color: #112239; /* Tono m√°s oscuro al pasar el rat√≥n */
            transform: scale(1.05);
        }

        /* Clase para ocultar el bot√≥n de forma robusta */
        .open-chat-button.hidden {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important; /* Deshabilita clics y eventos de rat√≥n */
        }

        /* Estilos para la imagen dentro del bot√≥n */
        .open-chat-button img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        /* Contenedor principal del chatbot cuando est√° abierto (como un popup en la esquina) */
        .chat-container {
            position: fixed;
            bottom: 25px; /* Ajuste para espacio con bot√≥n flotante */
            right: 25px; /* Ajuste para espacio con bot√≥n flotante */
            width: 90%;
            max-width: 350px; /* Tama√±o m√°s compacto */
            height: 80vh;
            max-height: 400px; /* Altura m√°xima m√°s compacta */
            background-color: var(--white);
            border-radius: 5px; /* Bordes menos redondeados */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            z-index: 1000;

            /* Ocultar inicialmente y aplicar transici√≥n para el movimiento */
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.8);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }

        /* Clase para mostrar el chat */
        .chat-container.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        /* Bot√≥n de cerrar el chat dentro del header */
        .close-chat-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: transparent;
            color: var(--white);
            border: none;
            font-size: 1em;
            cursor: pointer;
            z-index: 1001;
        }
        .close-chat-button:hover {
            color: var(--primary-medium-blue);
        }

        /* Bot√≥n de resetear chat en el header */
        .reset-chat-button {
            position: absolute;
            top: 10px;
            right: 40px; /* Ajuste para no chocar con el bot√≥n de cerrar */
            background-color: transparent;
            color: var(--white);
            border: none;
            font-size: 1em;
            cursor: pointer;
            z-index: 1001;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        .reset-chat-button:hover {
            opacity: 1;
            color: var(--primary-medium-blue);
        }


        /* Estilos del encabezado del chat */
        .chat-header {
            background-color: var(--primary-dark-blue);
            color: var(--white);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            border-bottom: 3px solid var(--primary-medium-blue);
            position: relative;
        }

        .chat-header .header-logo {
            height: 40px;
            margin-right: 15px;
            background-color: var(--white);
            padding: 5px;
            border-radius: 5px;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 1em; /* Texto m√°s peque√±o */
            font-weight: 500;
        }

        /* Estilos del √°rea de mensajes */
        .chat-messages {
            flex-grow: 1;
            padding: 10px; /* Menos padding */
            overflow-y: auto;
            background-color: var(--light-bg-blue);
            border-bottom: 1px solid #e0e0e0;
        }
/* NUEVO: Wrapper para cada mensaje y su timestamp */
.message-wrapper {
    display: flex;
    flex-direction: column; /* La burbuja y el timestamp se apilan */
    margin-bottom: 10px; /* Espacio entre wrappers de mensaje */
    max-width: 80%; /* Para que el wrapper no ocupe todo el ancho y se alinee */
}
/* Alineaci√≥n de los wrappers */
.message-wrapper.user-message-wrapper {
    align-self: flex-end; /* Alinea el wrapper a la derecha (para mensajes de usuario) */
    margin-left: auto; /* Empuja el wrapper a la derecha */
}
.message-wrapper.bot-message-wrapper {
    align-self: flex-start; /* Alinea el wrapper a la izquierda (para mensajes del bot) */
    margin-right: auto; /* Empuja el wrapper a la izquierda */
}

        .message {
            max-width: 100%;
            padding: 5px 10px; /* Menos padding */
            border-radius: 15px;
            margin-bottom: 10px;
            line-height: 1.0; /* Interlineado m√°s compacto */
            word-wrap: break-word;
            position: relative;
            padding-right: 40px; /* Espacio para el bot√≥n de copiar */
        }
        
/* NUEVO: Estilos para el elemento <audio> dentro de un mensaje */
.message audio {
    width: 100%; /* Que ocupe todo el ancho disponible en la burbuja */
    max-width: 180px; /* Limita el ancho m√°ximo para que no sea muy grande */
    height: 30px; /* Altura est√°ndar para los controles */
    margin-top: 5px; /* Peque√±o margen entre el texto y el reproductor */
    display: block; /* Asegura que se muestre en su propia l√≠nea */
    vertical-align: middle; /* Alineaci√≥n vertical */
    border-radius: 15px; /* Para que coincida con la burbuja */
    background-color: var(--light-bg-blue); /* Fondo sutil para el reproductor */
}
/* Estilos para el pie de p√°gina (timestamp) */
.message-timestamp {
    display: block; /* Asegura que ocupe su propia l√≠nea */
    font-size: 0.65em; /* Tama√±o de fuente m√°s peque√±o */
    color: var(--text-medium); /* Color gris medio para que sea discreto */
    opacity: 0.7; /* Ligeramente transparente */
    margin-top: 2px; /* Peque√±o espacio desde la burbuja */
    padding: 0 5px; /* Padding para el texto del timestamp */
    /* La alineaci√≥n del texto del timestamp dentro de su propio bloque */
    text-align: left; /* Alineaci√≥n por defecto a la izquierda */
}

/* Ajuste de texto del timestamp para mensajes de usuario (a la derecha) */
.user-message-wrapper .message-timestamp {
    text-align: right;
}
/* Ajuste de texto del timestamp para mensajes del bot (a la izquierda, ya es default) */
.bot-message-wrapper .message-timestamp {
    text-align: left;
}


        .user-message {
            background-color: var(--primary-medium-blue);
            color: var(--white);
            align-self: flex-end;
            margin-left: auto;
            font-size: 0.8em; /* Texto m√°s peque√±o */
            border-bottom-right-radius: 5px;
        }

        .bot-message {
            background-color: var(--white);
            color: var(--text-dark);
            align-self: flex-start;
            margin-right: auto;
            font-size: 0.8em; /* Texto m√°s peque√±o */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border-bottom-left-radius: 5px;
        }

        /* Estilos para el bot√≥n de copiar */
        .copy-button {
            position: absolute;
            top: 50%; /* Centrado vertical */
            right: 5px;
            transform: translateY(-50%);
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            opacity: 0.5;
            transition: opacity 0.2s ease;
            padding: 5px;
            border-radius: 5px;
            color: var(--text-dark); /* Color del icono */
        }
        /* Estilo espec√≠fico para la imagen dentro del bot√≥n de copiar */
        .copy-button img {
            width: 18px; /* Tama√±o del icono de copiar */
            height: 18px;
            vertical-align: middle; /* Alineaci√≥n para que quede bien */
        }

        .copy-button:hover {
            opacity: 1;
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* Estilos para el estado "copiado" (el checkmark) */
        .copy-button.copied-feedback {
            color: #2fa84b !important;
            font-size: 1.2em !important;
            opacity: 1 !important;
            transform: translateY(-50%) scale(1.2);
        }

        /* Estilos del √°rea de input de mensaje */
        .chat-input-area {
            display: flex;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan si no caben */
            padding: 10px 15px;
            background-color: var(--white);
            border-top: 1px solid #e0e0e0;
            align-items: center;
            /* Eliminamos 'gap' aqu√≠ para que el input-wrapper gestione el espacio */
            gap: 0; 
        }

        /* NUEVO: Wrapper para el input y los iconos internos */
        .chat-input-area .input-wrapper {
            position: relative; /* Para posicionar los iconos internos */
            display: flex; /* Para que el input y los botones internos se alineen */
            flex-grow: 1; /* Ocupa el espacio restante */
            align-items: center;
            border: 1px solid #ccc; /* El borde se mueve al wrapper */
            border-radius: 25px; /* Bordes redondeados se mueven al wrapper */
            overflow: hidden; /* Asegura que los hijos no se salgan */
            /* Padding right lo maneja el input para el send/mic */
            padding-right: 5px; /* Peque√±o padding para el send button al final */
            transition: border-color 0.3s ease;
        }

        .chat-input-area .input-wrapper:focus-within { /* Estilo al enfocar el input dentro del wrapper */
            border-color: var(--primary-dark-blue);
        }

        .chat-input-area input[type="text"] {
            flex-grow: 1; /* Input ocupa el espacio restante */
            padding: 8px 12px; /* Padding base */
            padding-left: 35px; /* Espacio para el icono de adjuntar a la izquierda */
            padding-right: 35px; /* Espacio para el icono de micro/enviar a la derecha */
            border: none; /* Eliminar el borde del input individual */
            border-radius: 0; /* Eliminar el redondeo del input individual */
            font-size: 0.8em;
            outline: none;
            background-color: transparent; /* Fondo transparente para ver los iconos */
        }

        /* Estilos comunes para los botones que van dentro del input visual */
        .chat-input-area .input-icon {
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-medium);
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
            padding: 5px; /* Ajustar padding */
            border-radius: 50%; /* Hacerlos redondos */
            position: absolute; /* Posicionamiento absoluto dentro del wrapper */
            top: 50%; /* Centrar verticalmente */
            transform: translateY(-50%); /* Ajuste fino */
            z-index: 2; /* Para que est√©n sobre el input */
            display: flex; /* Asegura que los iconos se centren si son flex/img */
            justify-content: center;
            align-items: center;
            font-size: 1.3em; /* Tama√±o por defecto para iconos */
            width: 30px; /* Ancho fijo para iconos */
            height: 30px; /* Alto fijo para iconos */
        }
        .chat-input-area .input-icon:hover {
            opacity: 1;
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Posicionamiento de los iconos espec√≠ficos */
        .chat-input-area .input-icon.left {
            left: 5px; /* Posicionar a la izquierda */
        }
        .chat-input-area .input-icon.right {
            right: 5px; /* Posicionar a la derecha */
        }

        /* Estilos espec√≠ficos para el bot√≥n de enviar (dentro del input) */
        .chat-input-area button#send-button {
            position: absolute; /* Absoluto para ir al final del input */
            right: 5px; /* Posicionar a la derecha */
            top: 50%;
            transform: translateY(-50%);
            background-color: transparent;
            color: var(--primary-dark-blue); /* Color del icono de enviar */
            border: none;
            width: 30px; /* Tama√±o del icono */
            height: 30px;
            font-size: 1.3em; /* Tama√±o del icono */
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%; /* Redondo */
            padding: 0; /* Eliminar padding extra */
            margin: 0; /* Eliminar margin-left */
            z-index: 3; /* Asegura que est√© por encima del micro */
            box-shadow: none; /* Eliminar sombra si no la queremos */
        }
        .chat-input-area button#send-button:hover {
            background-color: rgba(0, 0, 0, 0.05); /* Hover sutil */
            color: #112239; /* Hover sutil */
        }
        /* Icono de enviar cuando est√° deshabilitado */
        .chat-input-area button#send-button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Ajustes para el bot√≥n de micro cuando el de enviar est√° activo */
        .chat-input-area #mic-button {
            right: 40px; /* Moverlo a la izquierda para dejar espacio al bot√≥n de enviar */
        }
        /* Ocultar el bot√≥n de micro cuando el de enviar est√° visible */
        .chat-input-area #mic-button.hidden { /* Reutiliza la clase hidden */
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* NUEVO: Estilos para el contenedor de previsualizaci√≥n de medios (archivo/audio) */
        .staged-media-preview {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background-color: var(--light-bg-blue);
            border-radius: 5px;
            margin-top: 5px;
            font-size: 0.8em;
            color: var(--text-dark);
            border: 1px solid #e0e0e0;
            width: 100%;
            box-sizing: border-box;

            opacity: 0;
            height: 0;
            overflow: hidden;
            visibility: hidden;
            transition: opacity 0.3s ease, height 0.3s ease, margin-top 0.3s ease, visibility 0.3s ease;
        }

        .staged-media-preview.active {
            opacity: 1;
            height: auto;
            margin-top: 10px;
            visibility: visible;
        }

        /* NUEVO: Estilos para el bot√≥n de remover medio (la 'X') */
        .staged-media-preview .remove-staged-button {
            background-color: transparent;
            border: none;
            color: var(--text-medium);
            cursor: pointer;
            font-size: 1.2em;
            padding: 0 5px;
            line-height: 1;
            transition: color 0.2s ease, opacity 0.3s ease, visibility 0.3s ease;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
        .staged-media-preview .remove-staged-button.active {
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }
        .staged-media-preview .remove-staged-button:hover {
            color: red;
        }


        /* Scrollbar personalizado */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--light-bg-blue);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-dark-blue);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #112239;
        }

        /* Estilos para el indicador de escritura (tres puntos) */
        .typing-indicator {
            background-color: var(--white);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            width: fit-content;
            align-self: flex-start;
        }

        .typing-indicator p {
            margin: 0;
            display: flex;
            align-items: flex-end;
            gap: 3px;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: var(--text-medium);
            border-radius: 50%;
            opacity: 0.3;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.3;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <button id="open-chat-button" class="open-chat-button">
        <img src="https://cdn-icons-png.freepik.com/512/12220/12220340.png" alt="Abrir Chat">
    </button>

    <div id="chat-container" class="chat-container">
        <div class="chat-header">
            <img src="https://cdn-icons-png.freepik.com/512/12220/12220340.png" alt="Logo" class="header-logo">
            <h2>Asistente Virtual DployXperts</h2>
            <button id="close-chat-button" class="close-chat-button">‚úñ</button>
            <button id="reset-chat-button" class="reset-chat-button" title="Reiniciar chat">üîÑ</button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message bot-message">
                <p>¬°Hola! Soy tu asistente virtual DployXperts. ¬øEn qu√© puedo ayudarte hoy?</p>
            </div>
        </div>
  <div id="chat-input-area" class="chat-input-area">
    <div class="input-wrapper">
        <button id="attach-file-button" class="action-button input-icon left-icon" title="Adjuntar archivo">üìé</button>
        <input type="file" id="file-input" style="display:none;"/>
        <input type="text" id="user-input" placeholder="Escribe tu mensaje aqu√≠..." maxlength="300">
        <button id="mic-button" class="action-button input-icon right-icon" title="Grabar mensaje">üéôÔ∏è</button>
        <button id="send-button" class="action-button input-icon send-icon right-icon" title="Enviar mensaje">‚û§</button>
    </div>
    <div id="staged-media-preview" class="staged-media-preview">
        <span id="staged-media-name"></span>
        <button id="remove-staged-media" class="remove-staged-button">‚úñ</button>
   <audio id="staged-audio-player" controls style="display:none;"></audio> 
    </div>
</div>

<script type="text/javascript">

document.addEventListener('DOMContentLoaded', () => {
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const openChatButton = document.getElementById('open-chat-button');
    const closeChatButton = document.getElementById('close-chat-button');
    const resetChatButton = document.getElementById('reset-chat-button');
    const attachFileButton = document.getElementById('attach-file-button');
    const fileInput = document.getElementById('file-input');
    const micButton = document.getElementById('mic-button');
    const chatContainer = document.getElementById('chat-container');

    const stagedMediaPreview = document.getElementById('staged-media-preview'); // NUEVO
    const stagedMediaName = document.getElementById('staged-media-name'); // NUEVO
    const removeStagedMediaButton = document.getElementById('remove-staged-media'); // NUEVO
    const stagedAudioPlayer = document.getElementById('staged-audio-player'); // Tu reproductor de previsualizaci√≥n
//PRODUCCION
 //const N8N_WEBHOOK_URL = 'https://n8n.dployxperts.com/webhook/360e834f-3af9-4d76-8bf5-11684c2e6f1c';
//QA
 //const N8N_WEBHOOK_URL = 'https://n8n.dployxperts.com/webhook-test/360e834f-3af9-4d76-8bf5-11684c2e6f1c';
//odoo 2.0
const N8N_WEBHOOK_URL = 'https://n8n.dployxperts.com/webhook-test/fff5809a-2905-43d3-a7ca-1b931a40a23f';


    let sessionId = null;
    try {
        sessionId = localStorage.getItem('chatbotSessionId');
        if (!sessionId) {
            sessionId = 'session_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15) + Date.now();
            localStorage.setItem('chatbotSessionId', sessionId);
        }
        console.log("ID de Sesi√≥n de la conversaci√≥n:", sessionId); // Para depuraci√≥n
    } catch (e) {
        console.error("Error al gestionar el ID de sesi√≥n en localStorage. Se usar√° un ID temporal.", e);
        sessionId = 'fallback_session_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15) + Date.now();
    }


    let typingIndicatorElement = null;
    let mediaRecorder; 
    let audioChunks = []; 

    let stagedFile = null; // Variable para archivo en preparaci√≥n
    let stagedAudio = null; // Variable para audio en preparaci√≥n
    const originalSendButtonText = sendButton.textContent; // El texto original del bot√≥n de enviar es 'Enviar'

    // --- NUEVO: Funci√≥n para mostrar la previsualizaci√≥n del medio ---
    function showStagedMediaPreview(type, data) {
        stagedMediaPreview.classList.add('active');
        if (type === 'file') {
            stagedMediaName.textContent = `üìÑ ${data.fileName} (${(data.fileSize / 1024).toFixed(2)} KB)`;
        } else if (type === 'audio') {
            stagedMediaName.textContent = `üéµ Mensaje de voz (${(data.fileSize / 1024).toFixed(2)} KB)`;
        }
        sendButton.innerHTML = '‚û§'; // Cambiar a icono de enviar
        userInput.focus(); // Mantener foco en el input de texto
        removeStagedMediaButton.classList.add('active'); // Muestra el bot√≥n 'X'
    }

    // --- NUEVO: Funci√≥n para ocultar la previsualizaci√≥n del medio ---
    function hideStagedMediaPreview() {
        stagedMediaPreview.classList.remove('active');
        stagedMediaName.textContent = '';
        stagedFile = null;
        stagedAudio = null;
        sendButton.innerHTML = '‚û§'; // Asegurar que el bot√≥n de enviar sea el icono
        removeStagedMediaButton.classList.remove('active'); // Oculta el bot√≥n 'X'
    }

    // --- Funciones showTypingIndicator, hideTypingIndicator (sin cambios significativos) ---
      function showTypingIndicator() {
        if (!typingIndicatorElement) {
            typingIndicatorElement = document.createElement('div');
            typingIndicatorElement.classList.add('message', 'bot-message', 'typing-indicator');
            typingIndicatorElement.innerHTML = '<p><span>.</span><span>.</span><span>.</span></p>';
        }
        chatMessages.appendChild(typingIndicatorElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
     function hideTypingIndicator() {
        if (typingIndicatorElement && typingIndicatorElement.parentNode) {
            typingIndicatorElement.parentNode.removeChild(typingIndicatorElement);
        }
    }
    // --- Funciones abrir/cerrar/reset chat ---
    function openChat() {
        chatContainer.classList.add('active');
        openChatButton.style.display = 'none'; // Oculta el bot√≥n principal
        userInput.focus();
    }

    function closeChat() {
        chatContainer.classList.remove('active');
        openChatButton.style.display = 'flex';// Muestra el bot√≥n principal
    }

    function resetChat() {
        chatMessages.innerHTML = `
            <div class="message bot-message">
                <p>¬°Hola! Soy tu asistente virtual DployXperts. ¬øEn qu√© puedo ayudarte hoy?</p>
            </div>
        `;
        userInput.value = '';
        hideStagedMediaPreview(); // NUEVO: Limpiar previsualizaci√≥n al resetear
        console.log("Chat reseteado. Nuevo ID de Sesi√≥n:", sessionId);
        userInput.focus();
    }

    // --- L√≥gica del chatbot ---
    function appendMessage(sender, messageData, type = 'text') { // messageData puede ser string (texto) o File/Blob object
         const messageWrapper = document.createElement('div'); // NUEVO: Wrapper para la burbuja y el timestamp
        messageWrapper.classList.add('message-wrapper');
        // A√±adir clase de alineaci√≥n al wrapper (para usuario a la derecha, bot a la izquierda)
        if (sender === 'user') {
            messageWrapper.classList.add('user-message-wrapper');
        } else {
            messageWrapper.classList.add('bot-message-wrapper');
        }
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', `${sender}-message`);
        const messageParagraph = document.createElement('p');

        if (type === 'text') {
            messageParagraph.innerHTML = messageData;
 		messageDiv.appendChild(messageParagraph);

        } else if (type === 'audio') {
const audioTag = document.createElement('audio');
            audioTag.controls = true; // Mostrar los controles de reproducci√≥n (play/pause, volumen)
            audioTag.src = messageData.data; // messageData.data ya es la cadena Base64 'data:audio/webm;base64,...'
            audioTag.type = messageData.mimeType; // Asignar el tipo MIME para compatibilidad
            messageDiv.appendChild(audioTag); 
            messageParagraph.innerHTML = `üéµ Mensaje de voz (${(messageData.fileSize / 1024).toFixed(2)} KB)`; // Usar 'size' del Blob
		messageDiv.appendChild(messageParagraph);
            // Aqu√≠ podr√≠as a√±adir un <audio> tag para reproducir el audio si lo guardaste en URL.createObjectURL
        } else if (type === 'file') {
            messageParagraph.innerHTML = `üìÑ Archivo adjunto: ${messageData.fileName} (${(messageData.fileSize / 1024).toFixed(2)} KB)`; // Placeholder para archivo
            // Aqu√≠ podr√≠as a√±adir un enlace para descargar o previsualizar el archivo
  		messageDiv.appendChild(messageParagraph);

        }

      
        // --- NUEVO: A√±adir bot√≥n de copiar solo para mensajes del bot de tipo texto ---
        if (sender === 'bot' && type === 'text') {
            const copyButton = document.createElement('button');
            copyButton.classList.add('copy-button');
            copyButton.innerHTML = '<img src="https://cdn-icons-png.freepik.com/512/751/751410.png" alt="Copiar">'; 
            copyButton.title = 'Copiar mensaje';

            copyButton.addEventListener('click', () => {
                const textToCopy = messageParagraph.innerText; 
                
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        const originalIconHTML = copyButton.innerHTML;
                        copyButton.innerHTML = '‚úÖ'; 
                        copyButton.classList.add('copied-feedback'); 

                        setTimeout(() => {
                            copyButton.innerHTML = originalIconHTML; 
                        }, 1500);
                    })
                    .catch(err => {
                        console.error('Error al copiar el mensaje:', err);
                        alert('No se pudo copiar el mensaje. Por favor, int√©ntalo manualmente.'); 
                    });
            });
            messageDiv.appendChild(copyButton);
        }

        // --- NUEVO: Crear y a√±adir el timestamp ---
        const timestampSpan = document.createElement('span');
        timestampSpan.classList.add('message-timestamp');
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-ES', { hour: 'numeric', minute: '2-digit', hour12: true });
        const dateString = now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const statusText = sender === 'user' ? 'Enviado el' : 'Recibido el'; // "Enviado" o "Recibido"
        timestampSpan.textContent = `${statusText} ${dateString} - ${timeString} `;
        
        // Adjuntar la burbuja del mensaje y el timestamp al wrapper
        messageWrapper.appendChild(messageDiv);
        messageWrapper.appendChild(timestampSpan);

        chatMessages.appendChild(messageWrapper); // A√±adir el wrapper completo al contenedor de mensajes
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage() {
        let textMessageContent = userInput.value.trim(); // Texto actual en el input
        
        // Validar si hay algo que enviar (texto, audio o archivo)
        if (!textMessageContent && !stagedAudio && !stagedFile) {
            return; 
        }

        // --- Mostrar el mensaje del usuario en el historial antes del env√≠o ---
        if (textMessageContent) {
            appendMessage('user', textMessageContent, 'text');
        }
        if (stagedAudio) {
            appendMessage('user', stagedAudio, 'audio');
        } else if (stagedFile) {
            appendMessage('user', stagedFile, 'file');
        }
        
        userInput.value = ''; // Limpiar el input despu√©s de mostrarlo en el historial

        // Deshabilitar UI
        userInput.disabled = true;
        sendButton.disabled = true;
        sendButton.innerHTML = 'Enviando...'; // Cambiar innerHTML a texto durante el env√≠o
        micButton.disabled = true;
        attachFileButton.disabled = true;

        showTypingIndicator(); 

        try {
            const requestBody = {
                sessionId: sessionId
            };

            if (textMessageContent) {
                requestBody.message = textMessageContent;
            }
            
            if (stagedAudio) {
                requestBody.audio = stagedAudio;
            } else if (stagedFile) {
                requestBody.file = stagedFile;
            }

            // Ocultar la previsualizaci√≥n de medios
            hideStagedMediaPreview(); // NUEVO: Ocultar previsualizaci√≥n despu√©s de preparar el body

            const response = await fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const botResponse = data.response || "Lo siento, no pude obtener una respuesta.";
            appendMessage('bot', botResponse);

        } catch (error) {
            console.error('Error al conectar con el chatbot de n8n:', error);
            if (error.message === "No hay contenido real para enviar.") {
                appendMessage('bot', 'No se detect√≥ contenido para enviar. Escribe un mensaje o adjunta algo.');
            } else if (error.name === 'AbortError') {
                appendMessage('bot', 'El asistente est√° tardando demasiado en responder. Por favor, intenta de nuevo m√°s tarde.');
            } else if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                 appendMessage('bot', 'Hubo un problema de conexi√≥n con el asistente. Aseg√∫rate de tener Internet.');
            } else if (error instanceof SyntaxError && error.message.includes('Unexpected end of JSON input')) {
                 appendMessage('bot', 'La respuesta del asistente no fue completa. Por favor, intenta de nuevo.');
            }
            else {
                 appendMessage('bot', 'Lo siento, hubo un problema inesperado. Por favor, int√©ntalo de nuevo m√°s tarde.');
            }
        } finally {
            hideTypingIndicator(); 

            userInput.disabled = false;
            sendButton.disabled = false;
            sendButton.innerHTML = '‚û§'; // Vuelve al icono de enviar
            micButton.disabled = false;
            attachFileButton.disabled = false;

            userInput.focus();
        }
    }

    // --- L√≥gica de Grabaci√≥n de Voz ---
    micButton.addEventListener('click', async () => {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
 console.log("AudioBlob creado. Tipo:", audioBlob.type, "Tama√±o:", audioBlob.size, "bytes"); // LOG para ver el blob
                    if (audioBlob.size > 0) {
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);

                        reader.onloadend = () => {
                            stagedAudio = { data: reader.result, mimeType: audioBlob.type, fileSize: audioBlob.size }; // Almacenar, no enviar
                            showStagedMediaPreview('audio', stagedAudio); // NUEVO: Mostrar previsualizaci√≥n
                        };
                    } else {
                        console.warn("Grabaci√≥n de audio vac√≠a.");
                        alert("Grabaci√≥n vac√≠a. Intenta hablar m√°s claro.");
                    }
                    audioChunks = [];
                    micButton.classList.remove('recording');
                };

                mediaRecorder.start();
                micButton.classList.add('recording');
                console.log("Grabaci√≥n iniciada.");
            } catch (err) {
                console.error("Error al acceder al micr√≥fono:", err);
                alert("No se pudo acceder al micr√≥fono. Aseg√∫rate de dar permiso.");
            }
        } else if (mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            console.log("Grabaci√≥n detenida.");
        }
    });

    // --- L√≥gica de Adjuntar Archivo ---
    attachFileButton.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);

            reader.onloadend = () => {
                stagedFile = { data: reader.result, fileName: file.name, mimeType: file.type, fileSize: file.size }; // Almacenar, no enviar
                showStagedMediaPreview('file', stagedFile); // NUEVO: Mostrar previsualizaci√≥n
            };
        }
        event.target.value = '';
    });

    // --- NUEVO: Event Listener para el bot√≥n de remover medio preparado ---
    removeStagedMediaButton.addEventListener('click', hideStagedMediaPreview);


    // --- Event Listeners para enviar (texto, archivo o audio) ---
    sendButton.addEventListener('click', () => sendMessage());
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); 
            sendMessage();
        }
    });

    // --- Event Listeners para botones del header ---
    openChatButton.addEventListener('click', openChat);
    closeChatButton.addEventListener('click', closeChat);
    resetChatButton.addEventListener('click', resetChat);

    // --- Asegurar que el chat inicie SIEMPRE cerrado y vac√≠o ---
    //chatContainer.classList.remove('active');
    //openChatButton.classList.remove('hidden');
    hideStagedMediaPreview(); // NUEVO: Ocultar previsualizaci√≥n al cargar la p√°gina
});

</script>
</html>
